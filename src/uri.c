/*
 * uri.c
 *
 *  Created on: 2014年9月21日
 *      Author: blc
 */
#include <uri.h>

#include <stdlib.h>
#include <string.h>

#include <mem.h>

const char HEX2DEC[256] =
{
    /*       0  1  2  3   4  5  6  7   8  9  A  B   C  D  E  F */
    /* 0 */ -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1,
    /* 1 */ -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1,
    /* 2 */ -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1,
    /* 3 */  0, 1, 2, 3,  4, 5, 6, 7,  8, 9,-1,-1, -1,-1,-1,-1,		// 0, 1, 2, 3,  4, 5, 6, 7,  8, 9,

    /* 4 */ -1,10,11,12, 13,14,15,-1, -1,-1,-1,-1, -1,-1,-1,-1,		// -1, A, B, C,  D, E, F,-1, -1,-1,
    /* 5 */ -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1,
    /* 6 */ -1,10,11,12, 13,14,15,-1, -1,-1,-1,-1, -1,-1,-1,-1,		// -1, a, b, c,  d, e, f,-1,
    /* 7 */ -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1,

    /* 8 */ -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1,
    /* 9 */ -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1,
    /* A */ -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1,
    /* B */ -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1,

    /* C */ -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1,
    /* D */ -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1,
    /* E */ -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1,
    /* F */ -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1, -1,-1,-1,-1
};

int uri_decode(const char * psrc, int len, char * pres) {
	// Note from RFC1630:  "Sequences which start with a percent sign
	// but are not followed by two hexadecimal characters (0-9, A-F) are reserved
	// for future extension"
	unsigned char* srcuri = (unsigned char *)psrc;
	const unsigned char * const SRC_END = srcuri + len;
	const unsigned char * const SRC_LAST_DEC = SRC_END - 2; // last decodable '%'

	char * pstart = (char *) MALLOC(len);
	char * pend = pstart;

	while (srcuri < SRC_LAST_DEC) {
		if (*srcuri == '%') {
			char dec1, dec2;
			if (-1 != (dec1 = HEX2DEC[*(srcuri + 1)]) && -1 != (dec2 = HEX2DEC[*(srcuri + 2)])) {
				*pend++ = (dec1 << 4) + dec2;
				srcuri += 3;
				continue;
			}
		}
		*pend++ = *srcuri++;
	}

	// the last 2- chars
	while (srcuri < SRC_END)
		*pend++ = *srcuri++;
	int plen = (pend - pstart);
	memcpy(pres, pstart, plen);
	FREE(pstart);
	return plen;
}

// Only alphanum is safe.
//char SAFE[256] =
//{
//    /*      0 1 2 3  4 5 6 7  8 9 A B  C D E F */
//    /* 0 */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
//    /* 1 */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
//    /* 2 */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
//    /* 3 */ 1,1,1,1, 1,1,1,1, 1,1,0,0, 0,0,0,0,
//
//    /* 4 */ 0,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1,
//    /* 5 */ 1,1,1,1, 1,1,1,1, 1,1,1,0, 0,0,0,0,
//    /* 6 */ 0,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1,
//    /* 7 */ 1,1,1,1, 1,1,1,1, 1,1,1,0, 0,0,0,0,
//
//    /* 8 */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
//    /* 9 */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
//    /* A */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
//    /* B */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
//
//    /* C */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
//    /* D */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
//    /* E */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
//    /* F */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0
//};

char SAFE[256] =
{
    /*      0 1 2 3  4 5 6 7  8 9 A B  C D E F */
    /* 0 */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
    /* 1 */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
    /* 2 */ 0,1,0,1, 1,0,1,1, 1,1,1,1, 1,1,1,1,//  ,!,",#, $,%,&,', (,),*,+, ,,-,.,/
    /* 3 */ 1,1,1,1, 1,1,1,1, 1,1,1,1, 0,1,0,1,// 0,1,2,3, 4,5,6,7, 8,9,:,;, <,=,>,?

    /* 4 */ 1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1,// @,A,B,C, D,E,F,G, H,I,J,K, L,M,N,O
    /* 5 */ 1,1,1,1, 1,1,1,1, 1,1,1,0, 0,0,0,1,// P,Q,R,S, T,U,V,W, X,Y,Z,[, \,],^,_
    /* 6 */ 0,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1,// `,a,b,c, d,e,f,g, h,i,j,k, l,m,n,o
    /* 7 */ 1,1,1,1, 1,1,1,1, 1,1,1,0, 0,0,0,0,// p,q,r,s, t,u,v,w, x,y,z,{, |,},~,

    /* 8 */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
    /* 9 */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
    /* A */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
    /* B */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,

    /* C */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
    /* D */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
    /* E */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
    /* F */ 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0
};

int uri_encode(const char * psrc, int len, char * pres) {
	unsigned char* srcuri = (unsigned char*)psrc;
	const char DEC2HEX[16 + 1] = "0123456789ABCDEF";
	unsigned char * pstart = (unsigned char *) MALLOC(len * 3);
	unsigned char * pend = pstart;
	const unsigned char * const SRC_END = srcuri + len;
	for (; srcuri < SRC_END; ++srcuri) {
		if (SAFE[*srcuri]) {
			*pend++ = *srcuri;
		} else {
			// escape this char
			*pend++ = '%';
			*pend++ = DEC2HEX[*srcuri >> 4];
			*pend++ = DEC2HEX[*srcuri & 0x0F];
		}
	}
	int plen = pend - pstart;
	memcpy(pres, pstart, plen);
	FREE(pstart);
	return plen;
}
